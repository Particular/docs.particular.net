---
title: Report metrics to Azure Application Insights
component: Metrics
---

[Azure Application Insights](https://azure.microsoft.com/en-us/services/application-insights/) provides monitoring and alerting capabilities that can be leveraged to monitor the health of NServiceBus endpoints. This sample demonstrates the ability to report metric data to Azure Application Insights.

This sample reports the following metrics to Application Insights:

 * Fetched messages per second
 * Failed messages per second
 * Successful messages per second
 * Average message processing time
 * Average critical time

For a detailed explanation of these metrics see [Metrics - Metrics captured](/nservicebus/operations/metrics.md#metrics-captured).


## Prerequisites

An Application Insights account and instrumentation key. Instrumentation key can be obtained under Application Insights instance properties.


## Code overview

The sample simulates messages load with about 10% failure rate using `LoadSimulator`:

XX snippet: load-simulator


## Connect to Azure Application Insights

To connect the sample code to Application Insights, instrumentation key needs to be provided in the following manner:

XX snippet: configure-ai-instrumentation-key


## Use NServiceBus.Metrics to capture metric values

To capture metric values generated by NServiceBus, `ApplicationInsightsFeature` feature is is added to the sample. It enables NServiceBus metrics feature and is enabled by default.

XX snippet: enable-nsb-metrics

During setup stage of the feature, `ApplicationInsightsProbeCollector` is configured and wired. Information such as endpoint name and input queue are passed to allow data analysis in Application Insights.  


## Send captured metric data to Application Insights

`ApplicationInsightsProbeCollector` is used to pass NServiceBus captured metric data to the Application Insights instance configured earlier. Information passed in used as telemetry context properties and is attached to every metric (NServiceBus signal) and event (NServiceBus duration) captured via telemetry client used to communication with Application Insights.

XX snippet: telemtry-client

When `ApplicationInsightsProbeCollector` is registered with the NServiceBus metrics API, it registers a callback to receive data, signals and durations. Signals are converted into Application Insights custom events. Durations are converted into Application Insights metrics.

XX snippet: observers-registration


## Setting up charts for metrics and events (signals and durations)

TBD