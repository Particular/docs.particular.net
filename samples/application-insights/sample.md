---
title: Report metrics to Azure Application Insights
component: Metrics
---

[Azure Application Insights](https://azure.microsoft.com/en-us/services/application-insights/) provides monitoring and alerting capabilities that can be leveraged to monitor the health of NServiceBus endpoints. This sample demonstrates the ability to report metric data to Azure Application Insights.

This sample reports the following metrics to Application Insights:

 * Fetched messages per second 
 * Failed messages per second
 * Successful messages per second
 * Average message processing time in milliseconds
 * Maximum critical time in milliseconds

For a detailed explanation of these metrics refer to the [metrics captured section in the metrics documentation](/nservicebus/operations/metrics.md#metrics-captured).


## Prerequisites

To run this sample, an Application Insights account and instrumentation key are required.

Note: Although the sample uses Azure Application Insights, the solution itself does not have to run on an Azure message transport. This example uses the [Learning Transport](/transports/learning/) but could be modified to run on any [transport](/transports/).


## Code overview

The sample simulates messages load with a random 10% failure rate using the `LoadSimulator` class:

snippet: load-simulator


## Connect to Azure Application Insights

To connect the sample code to Application Insights, the instrumentation key needs to be provided.

By default the sample code loads this key from an environment variable called `ApplicationInsightKey`. Either set this environment variable or paste the instrumentation key in the following section.

snippet: configure-ai-instrumentation-key

The instrumentation key can be obtained under the Application Insights instance properties pane in the Azure portal.


## Use NServiceBus.Metrics to capture metric values

To capture the metric values generated by NServiceBus, a class called `ApplicationInsightsFeature` is added to the sample. It is responsible for enabling the NServiceBus metrics feature.

snippet: enable-nsb-metrics

`ApplicationInsightsProbeCollector` ensures that the telemetry probe is subscribed to the event stream. During this stage `ApplicationInsightsProbeCollector` is configured and wired. Information such as *endpoint name* and *input queue* are passed to allow advanced data analysis in Application Insights.  

snippet: register-probe

Events and metrics are buffered and the Application Insights telemetry client does this every minute. If the endpoint instance would gracefully stop it needs to ensure that any pending events are flushed to Application Insight.

snippet: flush-probe


## Sending data to Application Insights

The `ApplicationInsightsProbeCollector` is used to pass NServiceBus captured metric data to the Application Insights instance configured earlier. Information passed is added as telemetry context properties, which will be attached to every metric (NServiceBus signal probe) and event (NServiceBus duration probe) captured via the telemetry client. The telemetry client is used to communicate with Application Insights.

snippet: telemetry-client

When the `ApplicationInsightsProbeCollector` is registered with the NServiceBus metrics API, it registers observer callbacks to receive probe names, signals and durations. Signals are converted into Application Insights custom events. Durations are converted into Application Insights metrics.

snippet: observers-registration


## Creating charts

To create the charts, metrics provided by NServiceBus, signals and durations, need to be converted into Application Insights metrics and events.

The easiest way to setup graphs for metrics in Application Insights is to go to the `Metrics Explorer`, add a new graph selecting the custom metric of choice and then use the push pin symbol to add it to a dashboard.

The following graphs show the following metrics:

 * Maximum critical time & critical time grouped by instance id.
 * Average processing time, not grouped.
 * Minimum hours countdown until Service Level Agreement violation.

![example graph metrics](example-graph-metrics.png "width=50%")

Similar for events, the following graphs shows all events grouped by event name. This graph can be further filtered, for example, to show failures only.

![example graph events](example-graph-events.png "width=50%")

Refer to the Microsoft documentation for more information on [creating dashboards from the metrics explorer](https://docs.microsoft.com/en-us/azure/application-insights/app-insights-dashboards).

Using the metrics explorer is an easy way to get started, but to create truly advanced graphs Application Insights offers an [advanced analytics environment](https://docs.microsoft.com/en-us/azure/application-insights/app-insights-analytics). 
