---
title: NHibernate Custom mapping with hbm.xml, attributes or fluent api
summary: Create a custom mapping to change how NHibernate creates the database schema using different techniques.
reviewed: 2016-03-21
component: NHibernate
tags:
 - NHibernate
 - Mapping
related:
 - nservicebus/nhibernate
---


Sometimes the database schema that gets generated by `NServiceBus.NHibernate` for the saga data types is insufficient. For example, storing strings with a different string length, want so use complex types, need to store DateTime values with a high precision or maybe want to tweak the eager versus lazy loading to improve performance. A custom mapping will be required to achieve this, so that the generated default mapping will not be used.

Custom mapping options:

 * Create a `*.hbm.xml` file for the saga data class
 * Use Fluent NHibernate (popular separate fluent api)
 * Use NHibernate.Mapping.Attributes
 * Loquacious Configuration (native fluent api)

There are probably even other options, but these are the most frequently used.

Which method to use depends on if mapping as xml, fluent code or code attributes. There can be small performance differences during startup but not when processing messages.

NOTE: It is not required to create a custom mapping for all sagas if only one saga needs one. The NHibernate configuration in each sample type demonstrate how both generated and custom mappings can work simultaneously.

NOTE: When creating a custom mapping then mapping the **primary key** and **unique indexes** must be done as part of that mapping.

When using custom mappings ensure unique indexes for all mapped saga properties are correctly mapped. Especially when using optimistic concurrency, a transaction isolation level different from serializable and allow concurrent processing of messages.

Not adding a unique constraint can result in duplicate saga entities as the second insert will **not** fail when inserting the same value when multiple messages are processed concurrently referencing the same saga instance.


## Prerequisites

The samples rely on `.\SQLEXPRESS` and need the database `Samples.CustomNhMappings` to run properly.


## Custom .hbm.xml mapping

Using NHibernate mapping files is the native way to customize the mappings. The mapping files are xml files that are either embedded as a resource in the assembly or available on the file system.

For more information, see: [how to create a simple NHibernate based application](http://nhibernate.info/doc/tutorials/first-nh-app/your-first-nhibernate-based-application.html).


### The Mapping

The `.hbm.xml` contents is as follows

snippet:hmlxml


### Reading the mapping mappings

Create a custom NHibernate configuration object and use the following example to add mappings from the file system.

snippet:AddMappingsFromFilesystem


## Use Fluent NHibernate

[Fluent NHibernate](http://www.fluentnhibernate.org) gives a type-safe mapping approach where the mapping is specified as code (is not as `.hbm.xml`) but still separate from the classes. The benefit is compile time feedback when a mapping is not valid anymore when there are breaking changes in mappings but also that classes and mappings are not part of the same .NET type.

To use it with NServiceBus:

 1. Install `FluentNHibernate` package via NuGet.
 1. Create a custom NHibernate configuration
  * via FluentNHibernate
  * or by creating a new Configuration instance and pass it to FluentNHibernate
 1. Pass it to the NServiceBus NHibernate configuration.


Example of a possible implementation:

snippet:FluentConfiguration


## Use NHibernate.Mapping.Attributes

With [NHibernate.Mapping.Attributes](http://nhibernate.info/doc/nhibernate-reference/mapping-attributes.html) saga data classes can be decorated. This keeps the classes, mapping and schema data very close. The saga types have a dependency on the NHibernate.Mapping.Attributes assembly.

NHibernate.Mapping.Attributes needs to know what types to scan to generate an NHibernate mapping configuration that gets passed to the NHibernate configuration.

1. Add the NuGet package `NHibernate.Mapping.Attributes`
2. Create a custom NHibernate configuration object.
3. Initialize the attribute mapping (see sample below).
4. Pass it to the NServiceBus NHibernate configuration.


Initialize the NHibernate attribute based mappings:

snippet:AttributesConfiguration


## Use the Loquacious mapping by code API

The [NHibernate Loquacious api](http://nhibernate.info/doc/howto/mapping/a-fully-working-skeleton-for-sexy-loquacious-nh.html) is its native mapping by code. Declare the mapping in code just like FluentNHibernate but using a different syntax more close to its xml schema. It can help create a type-safe configuration but can also create the custom mappings. The benefit is that this api is already available via the NHibernate package so requires no additional downloads.

To use it:

1. Create a custom NHibernate configuration object.
2. Use either the model mapping or convention mapping features.
3. Pass it to the NServiceBus NHibernate configuration.


Initialize NHibernate Loquacious configuration

snippet:LoquaciousConfiguration
