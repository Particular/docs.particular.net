---
title: NServiceBus.NHibernate custom saga mapping sample
summary: An NServiceBus sample demonstrating a custom saga mapping to change how NHibernate creates the database schema using different techniques.
reviewed: 2024-12-28
component: NHibernate
related:
 - persistence/nhibernate
---

Sometimes, the database schema generated by `NServiceBus.NHibernate` is insufficient for saga data types. For example, storing strings with a different string length, wanting to use complex types, needing to store DateTime values with high precision, or wanting to tweak the eager versus lazy loading rules might be better options. A custom mapping will be required to achieve these changes.

Custom mappings can be added by:

* Creating a `*.hbm.xml` file for the saga data class
* Fluent NHibernate (popular separate fluent API)
* NHibernate.Mapping.Attributes
* Loquacious Configuration (native fluent API)

Other options exist, but these are the most frequently used. Minor variances in performance can exist between these options, but those will occur during endpoint startup, not when the endpoint is processing messages.

> [!NOTE]
> There is no requirement to create a custom mapping for all sagas if a custom mapping is needed by only one saga.

> [!NOTE]
> When creating a custom mapping, mapping the **primary key** and **unique indexes** is required.

When using a custom mapping, ensure a unique index exists for every column referenced by a `.ToSaga()` saga mapping expression. Not adding a unique constraint can result in duplicate saga entities. The second insert will **not** fail when inserting the same value if multiple messages are processed concurrently and they reference the same saga instance.

## Prerequisites

This sample requires an instance of SQL Server at `.\SqlExpress` and the database `Samples.CustomNhMappings` to run correctly.

## Custom .hbm.xml mapping

Using NHibernate mapping files is the native way to customize the mappings. The mapping files are xml files that are either embedded as a resource in the assembly or available on the file system.

For more information, see [how to create a simple NHibernate-based application](https://nhibernate.info/doc/tutorials/first-nh-app/your-first-nhibernate-based-application.html).

### Mapping

The `.hbm.xml` content is as follows:

snippet: hmlxml

### Configuration

Create a custom NHibernate configuration object and add mappings from the file system using the following example:

snippet: AddMappingsFromFilesystem

## Use Fluent NHibernate

[Fluent NHibernate](http://www.fluentnhibernate.org) provides a type-safe mapping approach where the mapping is specified in code (not as `.hbm.xml`), but the mapping is still separate from the classes. The benefit of this approach is the compile-time feedback provided when a mapping is invalid.

To use it with NServiceBus:

1. Install the `FluentNHibernate` package via NuGet.
1. Create a custom NHibernate configuration
   * via FluentNHibernate
   * or by creating a new Configuration instance and passing it to FluentNHibernate
1. Pass it to the NServiceBus NHibernate configuration.

### Mapping

snippet: FluentMapping

### Configuration

Example of a possible implementation:

snippet: FluentConfiguration

## Use NHibernate.Mapping.Attributes

Saga data classes can be decorated with [NHibernate.Mapping.Attributes](https://nhibernate.info/doc/nhibernate-reference/mapping-attributes.html). Saga types will have a dependency on the NHibernate.Mapping.Attributes assembly, but this keeps the classes, mapping, and schema data very close.

NHibernate.Mapping.Attributes needs to know what types to scan to generate an NHibernate mapping configuration that can be passed to the NServiceBus NHibernate configuration.

1. Add the NuGet package `NHibernate.Mapping.Attributes`
1. Create a custom NHibernate configuration object.
1. Initialize the attribute mapping (see sample below).
1. Pass it to the NServiceBus NHibernate configuration.

### Mapping

snippet: AttributesMapping

### Configuration

Initialize the NHibernate attribute-based mappings:

snippet: AttributesConfiguration

## Use the Loquacious mapping by code API

[NHibernate Loquacious API](https://nhibernate.info/doc/howto/mapping/a-fully-working-skeleton-for-sexy-loquacious-nh.html) is a native mapping for NHibernate that is provided via code. Like FluentNhibernate, the mapping is declared in code, but it uses a different syntax that is more closely aligned to NHibernate's xml schema. NHibernate Loquacious can help create type-safe configurations and custom mappings. The benefit of using NHibernate Loquacious is that this API is already available via the NHibernate package, requiring no additional downloads.

To use it:

1. Create a custom NHibernate configuration object.
1. Use either the model mapping or convention mapping features.
1. Pass it to the NServiceBus NHibernate configuration.

### Mapping

snippet: LoquaciousMapping

### Configuration

Initialize NHibernate Loquacious configuration:

snippet: LoquaciousConfiguration
