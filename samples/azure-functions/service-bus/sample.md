---
title: Using NServiceBus in Azure Functions (in-process)
summary: Using NServiceBus with Azure Service Bus triggers and Azure Functions in-process worker hosting model.
component: ASBFunctions
related:
 - nservicebus/hosting/azure-functions-service-bus
redirects:
 - samples/previews/azure-functions/service-bus
reviewed: 2024-08-02
---

This sample shows how to host NServiceBus within an Azure Function, in this case, a function triggered by an incoming Service Bus message. This enables hosting message handlers in Azure Functions, gaining the abstraction of message handlers implemented using `IHandleMessages<T>` and also taking advantage of NServiceBus's extensible message processing pipeline.

When hosting NServiceBus within Azure Functions, the Function (as identified by the `[FunctionName]` attribute) hosts an NServiceBus endpoint that is capable of processing different message types.

The Azure Functions SDK enforces certain constraints that are also applied to NServiceBus endpoints. Review these [constraints](/nservicebus/hosting/azure-functions-service-bus/) before running the sample.

downloadbutton

## Prerequisites

### Manually create queue

Unlike a traditional NServiceBus endpoint, an endpoint hosted in Azure Functions cannot create its own input queue. In this sample, that queue name is `ASBTriggerQueue`.

To create the endpoint with the [Azure Service Bus Transport CLI](/transports/azure-service-bus/operational-scripting.md), execute the following command:

```
asb-transport endpoint create ASBTriggerQueue
```

The command will create the required queue and topic.

### Configure Connection string

To use the sample, a valid Service Bus connection string must be provided in the `local.settings.json` file.

## Sample structure

The sample contains the following projects:
- `AzureFunctions.ASBTrigger.FunctionsHostBuilder` - NServiceBus endpoint
- `AzureFunctions.Messages` - message definitions

## Running the sample

The Functions project contains two functions:
1. An auto-generated Service Bus-triggered function. This function is generated by the `NServiceBusTriggerFunction` attribute in the `Startup.cs` file.
1. An HTTP-triggered function to send a message to the Azure Service Bus queue.

Running the sample will launch the **Azure Functions runtime** window.

To try the Azure Function:

1. Open a browser and navigate to <http://localhost:7071/api/HttpSender>. The port number might be different and will be indicated when the function project is started.
1. The queue-triggered function will receive the `TriggerMessage` and process it with NServiceBus.
1. The NServiceBus message handler for `TriggerMessage` sends a `FollowUpMessage`.
1. The queue-triggered function will receive the `FollowUpMessage` and process it with NServiceBus.

## Code walk-through

The NServiceBus endpoint configured using `IFunctionHostBuilder` in the `Startup` class like this:

snippet: configuration-with-function-host-builder

Note the `NServiceBusTriggerFunction` is used to automatically generate the Azure Functions trigger code that is needed to invoke NServiceBus.

### Handlers

These are the message handlers, with a `CustomDependency` passed in.

snippet: TriggerMessageHandler

snippet: FollowupMessageHandler
