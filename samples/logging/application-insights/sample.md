---
title: Report metrics to Azure Monitor Application Insights
summary: How to report NServiceBus metrics data to Azure Monitor Application Insights
component: Metrics
isLearningPath: true
reviewed: 2019-07-23
related:
 - monitoring/metrics
 - samples/azure
redirects:
- samples/application-insights
previewImage: example-graph-events.png
---


## Introduction

[Azure Application Insights](https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview) (App Insights) provides monitoring and alerting capabilities that can be leveraged to monitor the health of NServiceBus endpoints. This sample demonstrates how to report metric data to Azure Application Insights and present it graphically:

![example graph events](example-graph-events.png "width=500")

The sample reports the following metrics to App Insights:

 * Fetched messages per second 
 * Failed messages per second
 * Successful messages per second
 
 The sample also shows data like `Average message processing time in milliseconds` and `Maximum critical time in milliseconds`. For a detailed explanation of these metrics refer to the [metrics captured section in the metrics documentation](/monitoring/metrics/definitions.md).

## Prerequisites

To run this sample, an App Insights account and instrumentation key are required.

Note: Although the sample uses Azure Application Insights, the solution itself does not have to run on an Azure message transport. This example uses the [Learning Transport](/transports/learning/) but could be modified to run on any [transport](/transports/).


## Code overview

The sample simulates message load with a random 10% failure rate using the `LoadSimulator` class:

snippet: load-simulator


## Connect to Azure Application Insights

To connect the sample code to App Insights, the instrumentation key must be provided.

By default the sample code loads this key from an environment variable called `ApplicationInsightKey`. Either set this environment variable or paste the instrumentation key in the following section.

snippet: configure-ai-instrumentation-key

The instrumentation key can be retrieved from the Azure Portal by locating the App Insights instance, and then navigating to the Properties view.


## Use NServiceBus.Metrics to capture metric values

To capture the metric values generated by NServiceBus, a class called `ApplicationInsightsFeature` is added to the sample. It is responsible for enabling the NServiceBus metrics feature.

snippet: enable-nsb-metrics

`ProbeCollector` ensures that the telemetry probe is subscribed to the event stream. During this stage `ProbeCollector` is configured and wired. Information such as *endpoint name* and *input queue* are passed to allow advanced data analysis in App Insights.

snippet: register-probe

Events and metrics are buffered and the App Insights telemetry client does this every minute. If the endpoint instance would gracefully stop it must ensure that any pending events are flushed to App Insights.

snippet: flush-probe


## Sending data to App Insights

The `ProbeCollector` is used to pass NServiceBus-captured metric data to the App Insights instance configured earlier. Information is added as telemetry context properties, which will be attached to every metric (NServiceBus signal probe) and event (NServiceBus duration probe) captured via the telemetry client. The telemetry client is used to communicate with App Insights.

snippet: telemetry-client

When the `ProbeCollector` is registered with the NServiceBus metrics API, it registers observer callbacks to receive probe names, signals and durations. Signals are converted into App Insights custom events. Durations are converted into App Insights metrics.

snippet: observers-registration


## Creating charts

To create the charts, metrics provided by NServiceBus, as well as signals and durations must be converted into App Insights metrics and events.

One way to set up graphs for metrics in App Insights is to go to the `Metrics Explorer`, add a new graph selecting the custom metric of choice and then use the push pin symbol to add it to a dashboard.

The following graphs show the following metrics:

 * Maximum critical time & critical time grouped by instance id.
 * Average processing time, not grouped.
 * Minimum hours countdown until Service Level Agreement violation.

![example graph metrics](example-graph-metrics.png "width=500")

Similar for events, the following graphs show all events grouped by event name. This graph can be further filtered, for example, to show failures only.

![example graph events](example-graph-events.png "width=500")

Refer to the Microsoft documentation for more information on [creating dashboards from the metrics explorer](https://docs.microsoft.com/en-us/azure/application-insights/app-insights-dashboards).

Using the metrics explorer is an easy way to get started, but to create truly advanced graphs, App Insights offers an [advanced analytics environment](https://docs.microsoft.com/en-us/azure/application-insights/app-insights-analytics).