---
title: Report metrics to Azure Monitor Application Insights
summary: How to report NServiceBus metrics data to Azure Monitor Application Insights
component: Metrics
isLearningPath: true
reviewed: 2024-01-11
related:
 - monitoring/metrics
 - samples/azure
redirects:
- samples/application-insights
previewImage: example-graph-events.png
---

INFO: NServiceBus version 8 and above can export metric data to Application Insights via OpenTelemetry without the metrics package. See [this sample](/samples/open-telemetry/application-insights/) for more details.

## Introduction

[Azure Application Insights](https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview) (App Insights) provides monitoring and alerting capabilities that can be leveraged to monitor the health of NServiceBus endpoints. This sample demonstrates how to report [custom events and metrics](https://learn.microsoft.com/en-us/azure/azure-monitor/app/api-custom-events-metrics) data to Azure Application Insights and present it graphically:

![example graph events](example-graph-events.png "width=500")

The sample reports the following as custom events:

* `Fetched` - A message was fetched from the endpoint input queue
* `Success` - A message was successfully processed
* `Failed` - A message failed to be processed

The sample reports the following as custom metrics:

* `Processing Time (ms)`- The time since a message was fetched from the queue until processed
* `Critical Time (ms)` - The time since a message was sent until successfully processed

For a detailed explanation of these metrics refer to the [metrics captured section in the metrics documentation](/monitoring/metrics/definitions.md).

## Prerequisites

To run this sample, a provisioned App Insights resource and connection string is required.

Note: Although the sample uses Azure Application Insights, the solution itself does not have to run on an Azure message transport. This example uses the [Learning Transport](/transports/learning/) but could be modified to run on any [transport](/transports/).

## Code overview

The sample simulates message load with a random 10% failure rate using the `LoadSimulator` class:

snippet: load-simulator

## Connect to Azure Application Insights

To connect the sample code to App Insights, the connection string must be provided.

snippet: configure-ai-instrumentation-key

The connection string can be retrieved from the Azure Portal by locating the App Insights instance, and then navigating to the Properties view.

## Use NServiceBus.Metrics to capture metric values

To capture the events and metrics generated by NServiceBus, a class called `ApplicationInsightsFeature` is added to the sample. It is responsible for enabling the NServiceBus metrics feature.

snippet: enable-nsb-metrics

`ProbeCollector` ensures that the telemetry probe is subscribed to the event stream. During this stage, `ProbeCollector` is configured and wired. Information such as *endpoint name* and *input queue* are passed to allow advanced data analysis in App Insights.

snippet: register-probe

Events and metrics are buffered and the App Insights telemetry client does this every minute. If the endpoint instance would gracefully stop it must ensure that any pending events are flushed to App Insights.

snippet: flush-probe

## Sending data to App Insights

The `ProbeCollector` is used to pass NServiceBus-captured data to the App Insights instance configured earlier. Information is added as telemetry context properties, which will be attached to every metric (NServiceBus signal probe) and event (NServiceBus duration probe) transmitted via the telemetry client.

snippet: telemetry-client

When the `ProbeCollector` is registered with the NServiceBus metrics API, it registers observer callbacks to receive probe names, signals, and durations. Signals are converted into App Insights custom events. Durations are converted into App Insights custom metrics.

snippet: observers-registration

## Creating charts

To set up graphs for metrics in App Insights go to the `Metrics Explorer`, add a new graph select the custom metric of choice, and then use the push pin symbol to add it to a dashboard.

The following graphs show the following metrics:

* Maximum critical time grouped by instance id.
* Average processing time, not grouped.
* Countdown in hours until Service Level Agreement violation.

![example graph metrics](example-graph-metrics.png "width=500")

Similar to metrics, the following graphs show all events grouped by event name. This graph can be further filtered, for example, to show failures only.

![example graph events](example-graph-events.png "width=500")

Refer to the Microsoft documentation for more information on [creating dashboards from the Metrics Explorer](https://docs.microsoft.com/en-us/azure/application-insights/app-insights-dashboards).

Using the Metrics Explorer is an easy way to get started, but to create truly advanced graphs, App Insights offers an [advanced analytics environment](https://docs.microsoft.com/en-us/azure/application-insights/app-insights-analytics).
