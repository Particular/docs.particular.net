---
title: Isolated Worker
component: ASBFunctionsWorker
summary: Using NServiceBus with the Azure Functions isolated worker hosting model.
related:
  - samples/azure-functions/service-bus-worker
reviewed: 2021-08-30
---

The isolated worker model is a newer hosting option for Azure Functions. Running out-of-process decouples the function code from the Azure Functions runtime. For further information about the isolated worker, refer to the [Microsoft documentation](https://docs.microsoft.com/en-us/azure/azure-functions/dotnet-isolated-process-guide).

## Usage

NServiceBus supports the isolated worker hosting model via the `NServiceBus.AzureFunctions.Worker.ServiceBus` NuGet package. The following configuration enables NServiceBus:

snippet: asb-function-isolated-configuration

The Azure Service Bus trigger is automatically generated by the `NServiceBusTriggerFunction` attribute which will forward incoming messages to the appropriate message handlers.

### Dispatching outside a message handler

To send/publish messages outside a message handler, inject `IFunctionEndpoint` into custom triggers. This snippet shows an HTTP trigger sending a message via NServiceBus:

snippet: asb-function-isolated-dispatching-outside-message-handler

## Configuration

`ServiceBusTriggeredEndpointConfiguration` loads certain configuration values from the Azure Function host environment in the following order:

1. `IConfiguration`
2. Environment variables

| Key                      | Value      | Notes     |
|--------------------------|------------|-----------|
| `AzureWebJobsServiceBus` | Connection string for the Azure ServiceBus namespace to connect to | This value is required for `ServiceBusTriggerAttribute`. |
| `NSERVICEBUS_LICENSE`    | The NServiceBus license | Can also be provided via `serviceBusTriggeredEndpointConfig.AdvancedConfiguration.License(...)`. |
| `ENDPOINT_NAME`          | The name of the NServiceBus endpoint to host | Optional. By default, the endpoint name is derived from the `NServiceBusTriggerFunction` attribute. |
| `WEBSITE_SITE_NAME`      | The name of the Azure Function app. Provided when hosting the function in Azure. | Optional. Used to set the NServiceBus [host identifier](/nservicebus/hosting/override-hostid.md). Local machine name is used if not set. |

For local development, use the `local.settings.json` file. In Azure, specify a Function setting using the environment variable as the key.

include: license-file-local-setting-file

## Custom triggers

Custom trigger definitions for Azure Service Bus triggers using NServiceBus message handlers are currently not supported. Use the `ServiceBusTriggerAttribute` to configure the auto-generated Azure Service Bus trigger.

### Transactions

Unlike the [in-process hosting model](/nservicebus/hosting/azure-functions-service-bus), the isolated worker model does not support using [`TransportTransactionMode.SendsAtomicWithReceive`](/transports/transactions.md#transactions-transport-transaction-sends-atomic-with-receive). [`TransportTransactionMode.ReceiveOnly`](/transports/transactions.md#transactions-transport-transaction-receive-only) is the default option.

### Custom diagnostics

[NServiceBus startup diagnostics](/nservicebus/hosting/startup-diagnostics.md) are disabled by default when using Azure Functions. Diagnostics can be written to the logs via the `LogDiagnostics` option:

snippet: asb-function-isolated-enable-diagnostics

Diagnostics data will be written with logger identification `StartupDiagnostics` with log level *Informational*.

### Error queue

By default, repeatedly failing messages are sent to the `error` queue. The error queue can be configured or disabled completely to let the native Azure Service Bus dead-lettering configuration handle failures:

snippet: asb-function-isolated-configure-error-queue

### Known constraints and limitations

The configuration API exposes NServiceBus transport configuration options via the `configuration.Transport` property to allow customization. However, not all of the options will be applicable to execution within Azure Functions.

partial: no-use-transport

## Preparing the Azure Service Bus namespace

Function endpoints cannot create their own queues or other infrastructure in the Azure Service Bus namespace.

Use the [`asb-transport` command line (CLI) tool](/transports/azure-service-bus/operational-scripting.md) to provision the entities in the namespace for the Function endpoint.

### Creating the endpoint queue

```
asb-transport endpoint create <queue name>
```

See the [operation scripting documentation](/transports/azure-service-bus/operational-scripting.md#operational-scripting-asb-transport-endpoint-create) for the `asb-transport endpoint create` command for more details.

WARN: If the `asb-tranport` command-line tool is not used to create the queue, it is recommended to set the `MaxDeliveryCount` setting to the maximum value.

### Subscribing to events

```
asb-transport endpoint subscribe <queue name> <eventtype>
```

See the [operational scripting documentation](/transports/azure-service-bus/operational-scripting.md#operational-scripting-asb-transport-endpoint-subscribe) for the `asb-transport endpoint subscribe` command for more details.

## Package requirements

`NServiceBus.AzureFunctions.Worker.ServiceBus` requires Visual Studio 2019 and .NET SDK version `5.0.300` or higher. Older versions of the .NET SDK might display the following warning which prevents the trigger definition from being auto-generated:

```
CSC : warning CS8032: An instance of analyzer NServiceBus.AzureFunctions.SourceGenerator.TriggerFunctionGenerator cannot be created from ServiceBus.AzureFunctions.Worker.SourceGenerator.dll : Could not load file or assembly 'Microsoft.CodeAnalysis, Version=3.10.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35'. The system cannot find the file specified..
```

Starting in version 4.1.0 of `NServiceBus.AzureFunctions.Worker.ServiceBus`, warning CS8032 is treated as an error. To suppress this error, update the project's .csproj file to include the following line in the `<PropertyGroup>` section at the top:

```xml
  <WarningsAsErrors></WarningsAsErrors>
```

This will revert CS8032 to a warning status so that it does not stop the build process.
