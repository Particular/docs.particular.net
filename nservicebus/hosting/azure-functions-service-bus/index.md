---
title: Azure Functions with Service Bus (Isolated Worker)
component: ASBFunctionsWorker
summary: Using NServiceBus with the Azure Functions isolated worker hosting model.
related:
  - samples/azure-functions/service-bus-worker
reviewed: 2024-08-06
---

The isolated worker model is a newer hosting option for Azure Functions. Running out-of-process decouples the function code from the Azure Functions runtime. For further information about the isolated worker, refer to the [Microsoft documentation](https://docs.microsoft.com/en-us/azure/azure-functions/dotnet-isolated-process-guide).

## Usage

NServiceBus supports the isolated worker hosting model via the `NServiceBus.AzureFunctions.Worker.ServiceBus` NuGet package. The following configuration enables NServiceBus:

> [!NOTE]
> An Azure function project can only contain a single `NServiceBusTriggerFunction` attribute. A project maps to a single Azure Service Bus queue to process incoming messages.

snippet: asb-function-isolated-configuration

The Azure Service Bus trigger is automatically generated by the `NServiceBusTriggerFunction` attribute, which forwards incoming messages to the appropriate message handlers.

If customization of the Azure Service Bus trigger is required, it can be manually declared instead of relying on the auto-generated trigger. See the article on [custom Azure Functions triggers](/nservicebus/hosting/azure-functions-service-bus/custom-triggers.md) for more information.

### Dispatching outside a message handler

To send/publish messages outside a message handler, inject `IFunctionEndpoint` into custom triggers. This snippet shows an HTTP trigger sending a message via NServiceBus:

snippet: asb-function-isolated-dispatching-outside-message-handler

partial: configuration

### Transactions

Unlike the [in-process hosting model](/nservicebus/hosting/azure-functions-service-bus/in-process/), the isolated worker model does not support using [`TransportTransactionMode.SendsAtomicWithReceive`](/transports/transactions.md#transaction-modes-transport-transaction-sends-atomic-with-receive). [`TransportTransactionMode.ReceiveOnly`](/transports/transactions.md#transaction-modes-transport-transaction-receive-only) is the default option.

### Startup Diagnostics

[NServiceBus startup diagnostics](/nservicebus/hosting/startup-diagnostics.md), which help troubleshoot configuration and initialization issues, are disabled by default when using Azure Functions. Diagnostics can be written to the application log file via the `LogDiagnostics()` method and will show up in the [Azure Function log stream](https://learn.microsoft.com/en-us/azure/azure-functions/streaming-logs?tabs=built-in%2Cazure-portal).

snippet: asb-function-isolated-enable-diagnostics

Diagnostics data will be written with logger identification `StartupDiagnostics` with log level *Informational* (`LogLevel.Info`).

#### Custom Diagnostics Writer

For full control over the diagnostic log output, the `AdvancedConfiguration.CustomDiagnosticsWriter` can be used. This is advantageous when diagnostics need to be persisted beyond the function's execution lifetime or when centralized diagnostic storage is preferred for multiple function instances. As an example, the diagnostics can be written to [Azure BLOB Storage](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-quickstart-blobs-dotnet?tabs=visual-studio%2Cmanaged-identity%2Croles-azure-portal%2Csign-in-azure-cli%2Cidentity-visual-studio&pivots=blob-storage-quickstart-scratch):

snippet: asb-function-iso-diagnostics-blob

### Error queue

By default, repeatedly failing messages are sent to the `error` queue. The error queue can be configured or disabled completely to let the native Azure Service Bus dead-lettering configuration handle failures:

snippet: asb-function-isolated-configure-error-queue

### Known constraints and limitations

The configuration API exposes NServiceBus transport configuration options via the `configuration.Transport` property to allow customization. However, not all options will be [applicable to execution within Azure Functions](./analyzers.md).

Use the `configuration.Routing` property to configure transport routing.

## Preparing the Azure Service Bus namespace

Function endpoints can create queues or other infrastructure in the Azure Service Bus namespace using the `configuration.AdvancedConfiguration.EnableInstallers()` method.

To manually provision the entities in the namespace for the Function endpoint, use the [`asb-transport` command line (CLI) tool](/transports/azure-service-bus/operational-scripting.md).

### Creating the endpoint queue

For more details, see the [operation scripting documentation](/transports/azure-service-bus/operational-scripting.md#available-commands-asb-transport-endpoint-create) for the `asb-transport endpoint create` command.

> [!WARNING]
> If the `asb-transport` command-line tool is not used to create the queue, set the `MaxDeliveryCount` setting to the maximum value.

### Subscribing to events

For more details, see the [operational scripting documentation](/transports/azure-service-bus/operational-scripting.md#available-commands-asb-transport-endpoint-subscribe) for the `asb-transport endpoint subscribe` command.

partial: topology

partial: package-requirements
