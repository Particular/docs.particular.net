---
title: Migrate handlers and sagas to Version 6
reviewed: 2016-08-29
component: Core
related:
 - nservicebus/handlers
 - nservicebus/sagas
redirects:
 - nservicebus/upgrades/5to6-migrate-existing-handlers
isUpgradeGuide: true
upgradeGuideCoreVersions:
 - 5
 - 6
---

The handler method on `IHandleMessages<T>` now returns a Task. In order to leverage async code, add the `async` keyword to the handler method and use `await` for async methods. In order to convert the synchronous code add `return Task.FromResult(0);` or `return Task.CompletedTask` (.NET 4.6 and higher) to the handler methods.

WARNING: Do not `return null` from the message handlers. A `null` will result in an Exception.

snippet: 5to6-messagehandler


## API Changes


### Bus Send and Receive

There is also a change in the parameters, giving access to the `IMessageHandlerContext`, which provides the methods that used to be called from `IBus`. Use the `IMessageHandlerContext` to send and publish messages.

snippet: 5to6-bus-send-publish


### Message handler ordering

In Version 6 the message handler ordering APIs are simplified. The full API can be seen in [Handler ordering](/nservicebus/handlers/handler-ordering.md).


#### Specifying a Handler to run first

snippet: 5to6HandlerOrderingWithFirst


#### Specifying Handler order

snippet: 5to6HandlerOrderingWithCode


### New context arguments

The signature for the mutators now passes context arguments that give access to relevant information on the message and also the mutation the message. This context will give access to the same functionality as previous versions so just update the code accordingly.

See [header manipulation](/nservicebus/messaging/header-manipulation.md) for one example on how this might look.


## Migration


In previous versions of NServiceBus, a typical handler class looks like the below:

snippet: 5to6-handler-migration-beginning

Implement the new `IHandleMessages` interface. Remove any code that is generated by the IDE or additional tools like Resharper and mark the new `Handle` method as `async` by adding the `async` keyword.

snippet: 5to6-handler-migration-step1

Rename the bus property or the bus constructor parameter to `context`. Although the [IBus interface has been deprecated](moving-away-from-ibus.md) and can be safely removed, for this step renaming the property instead of deleting it comes in useful when refactoring existing code. It's much easier to rename all the existing references from `bus` property to `context`.

snippet: 5to6-handler-migration-step2

Inline or "cut-and-paste" the old `Handle` method code into the new asynchronous `Handle` method. When the code is compiled a compiler warning [`CS4014`](https://msdn.microsoft.com/en-us/library/hh873131.aspx) will be shown indicating that there are asynchronous methods in the handler which are not awaited.

snippet: 5to6-handler-migration-step3

Fix the compiler warnings by introducing the `await` statement followed by `ConfigureAwait(false)` to each asynchronous method call.

NOTE: Visual Studio 2015 and higher has the capability to automatically fix those warnings with the [`Ctrl+.`](https://msdn.microsoft.com/en-us/library/dn872466.aspx) (depending on the keybindings) shortcut. It is even possible to fix it in the whole solution if desired.

snippet: 5to6-handler-migration-step4

After these steps start moving other code in the handler towards async if the code supports it when it is desired to fully leverage async/await. For example with Entity Framework instead of calling `SaveChanges` call `SaveChangesAsync` on the database context.


## Saga API Changes


### Remove NServiceBus.Saga namespace

The `NServiceBus.Saga` namespace has been removed to stop it clashing with the `NServiceBus.Saga.Saga` class. For all commonly used APIs (eg the `Saga` class and `IContainSagaData ` interface) they have been moved into the `NServiceBus` namespace. Other more advanced APIs (eg the `IFinder` and `IHandleSagaNotFound` interfaces) have been moved into the `NServiceBus.Sagas` namespace.

In most cases `using NServiceBus.Saga` can be replaced with `using NServiceBus`.


### Unique attribute no longer needed

NServiceBus will automatically make the correlated saga property unique without the need for an explicit `[Unique]` attribute to be used. This attribute can be safely removed from saga data types.


### ConfigureHowToFindSaga

All messages that start the saga (`IAmStartedByMessages<T>`) need to be mapped to the saga data using either a mapping in `ConfigureHowToFindSaga` method, or a custom [saga finder](/nservicebus/sagas/saga-finding.md), otherwise an exception will be thrown on endpoint startup. Other messages that are handled by the saga (`IHandleMessages<T>`) also require mappings, unless they are reply messages resulting from a message sent out of the saga, in which case they will contain the SagaId in a message header. Messages that cannot be mapped by a SagaId message header, by a property mapping in `ConfigureHowToFindSaga`, or via a custom saga finder will throw a runtime exception.

In the below example, the `OrderSaga` is started by the `StartOrder` message. The `OrderSaga` also handles the `CompleteOrder` message.

snippet: 5to6-SagaDefinition

In Version 6, the `StartOrder` message will also need to be specified in the `ConfigureHowToFindSaga` method.

snippet: 5to6-ConfigureHowToFindSaga


### Correlating properties

Version 6 automatically correlates incoming message properties to its saga data counterparts. Any saga data correlation in the message handler code can be safely removed. Correlated properties (for existing saga instances) will not be changed once set.

{{NOTE: Correlated properties must have a non [default](https://msdn.microsoft.com/en-us/library/83fhsxwc.aspx) value, i.e. not null and not empty, assigned when persisted. If not the following exception will be thrown: 

```no-highlight
The correlated property 'MyPropery' on saga 'MySaga' does not have a value.
A correlated property must have a non default (i.e. non null and non-empty) value assigned when a new saga instance is created.
```

Use a [custom finder](/nservicebus/sagas/saga-finding.md) for the received message to override this validation.
}}

snippet: 5to6-NoSagaDataCorrelationNeeded

Versions 6 and above will only support correlating messages to a single saga property. Correlating on more than one property is still supported by creating a custom [saga finder](/nservicebus/sagas/saga-finding.md). If sagas with multiple correlations mappings to different properties are detected the following exception will be thrown:

```no-highlight
Sagas can only have mappings that correlate on a single saga property. Use custom finders to correlate *message types* to saga *saga type*
```


### Saga persisters & finders

Saga persisters (`ISagaPersister`) and finders (`IFindSagas`) introduce a new parameter `SagaPersistenceOptions`. This parameter gives access to the saga metadata and pipeline context. This enables  persisters and finders to manipulate everything that exists in the context during message pipeline execution. For more information see [Sagas](/nservicebus/sagas/) and [Complex saga finding logic](/nservicebus/sagas/saga-finding.md).


### MarkAsComplete no longer virtual

The `Saga` base class method `MarkAsComplete` is no longer virtual.


### RequestTimeout requires IMessageHandlerContext

`RequestTimeout` requires a `IMessageHandlerContext` as additional parameter. Pass the context argument received in the handle method to `RequestTimeout`.


### ReplyToOriginator requires IMessageHandlerContext

`ReplyToOriginator` requires a `IMessageHandlerContext` as additional parameter. Pass the context argument received in the handle method to `RequestTimeout`.
