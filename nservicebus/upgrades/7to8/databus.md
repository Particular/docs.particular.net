---
title: Upgrading Databus from Version 7 to 8
summary: Instructions on how to upgrade databus usage from NServiceBus version 7 to version 8.
reviewed: 2022-05-19
component: Core
isUpgradeGuide: true
upgradeGuideCoreVersions:
 - 7
 - 8
---

The BinaryFormatter serializer that was used internally in NServiceBus version 7 is removed to a separate package. The BinaryFormatter is unsafe by nature and could cause security vulnerabilities and is being phased out by Microsoft. The new DataBus configuration API accepts a serializer that need to be provided. The recommended serializer is `SystemJsonDataBusSerializer` that is built-in and uses `System.Text.Json` library. While BinaryFormatter is still supported via the new package called `NServiceBus.DataBus.BinarySerializer`, customers are strongly recommended to move away from it.

## Removal of dependency injection support

The serializer interface `IDataBusSerializer` can no longer be resolved via the container. Registered custom DataBus serializer, now need to be provided in code and the registration code can be removed:

```csharp
endpointConfiguration.UseDataBus<FileShareDataBus, SystemJsonDataBusSerializer>();
```

A runtime exception is thrown if the `IDataBusSerializer` is still registered in the container.

## Implementing custom serializers

The `IDataBusSerializer` interface is changed to better isolate type information causing security concerns. Custom implementations of this interface should ignore type information embedded in the persisted payload and use the `propertyType` passed to the `Deserialize` method:

```csharp
public object Deserialize(Type propertyType, Stream stream)
```

## Migration from BinaryFormatter

When an exception is thrown during deserialization of DataBus messages, additional deserializers will be added. This can be used to roll our migration away from binary formatter. The following strategy is may be applicable:

- Roll out endpoints using NServiceBus 8 and keep using the binary formatter using the new package `NServiceBus.DataBus.BinarySerializer`. Add `SystemJsonDataBusSerializer` as the secondary deserializer. This ensures any data bus payload generated by NServiceBus 8 and `SystemJsonDataBusSerializer` can be handled in addition to the older endpoints or in-flight databus messages.
- Switch the main deserializer to the `SystemJsonDataBusSerializer` and use `BinarySerializer` as the secondary deserializer. This can be done per endpoint so that endpoints start generating _new_ databus payloads using the new serializer. The secondary deserializer can handle messages from endpoints still on the older serializer.
- Once all endpoints are migrated and the in-flight messages are processed, remove the `BinarySerializer` as secondary serializer altogether.

Note that the newly added header called `NServiceBus.DataBus.ContentType` in NServiceBus version 8 determines which deserializer should be picked. The lack of the header means the main deserializer will be used first, followed by the additional configured deserializers.